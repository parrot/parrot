{"version":1,"ops":[{"type":1,"author":{"id":"0c9c62332064205b2d799407019fa3e7e2f43862"},"timestamp":1257830500,"metadata":{"github-id":"MDU6SXNzdWUyODQ4ODY4","github-url":"https://github.com/parrot/parrot/issues/659","origin":"github"},"title":"[BUG] hash iterator interface changed, needs errata or deprecation notice","message":"The following code worked in Parrot 1.0.0 (r37535) and Parrot 1.3.0 (r39599):\n\n```\n$ cat hash-1.pir\n.sub 'main'\n    .local pmc hash, hash_it\n    hash = new ['Hash']\n    hash['1'] = 'a' \n    hash['2'] = 'b'\n    hash['3'] = 'c'\n\n    hash_it = iter hash\n  loop:\n    unless hash_it goto done\n    $P0 = shift hash_it\n    $P1 = concat $P0, 'x'\n    say $P1\n    goto loop\n  done:\n.end\n\n$ 37535/parrot hash-1.pir\n1x\n2x\n3x\n$ 39599/parrot hash-1.pir\n1x\n2x\n3x\n```\n\nThe same code fails in 1.4.0 (r40185) and current trunk:\n\n```\n$ 40185/parrot hash-1.pir\nMultiple Dispatch: No suitable candidate found for 'concatenate_str', with signature 'PSP-\u003eP'\ncurrent instr.: 'main' pc 24 (hash-1.pir:12)\n$ trunk/parrot hash-1.pir\nMultiple Dispatch: No suitable candidate found for 'concatenate_str', with signature 'PSP-\u003eP'\ncurrent instr.: 'main' pc 24 (hash-1.pir:13)\n$ \n```\n\nThe problem is not limited to the concat opcode -- other opcodes cause problems also:\n\n```\n$ cat hash-2.pir\n.sub 'main'\n    .local pmc hash, hash_it\n    hash = new ['Hash']\n    hash['1'] = 'a' \n    hash['2'] = 'b'\n    hash['3'] = 'c'\n\n    hash_it = iter hash\n  loop:\n    unless hash_it goto done\n    $P0 = shift hash_it\n    $P1 = add $P0, 100\n    say $P1\n    goto loop\n  done:\n.end\n\n$ 37535/parrot hash-2.pir\n101\n102\n103\n$ 39599/parrot hash-2.pir\n101\n102\n103\n$ 40185/parrot hash-2.pir\nMultiple Dispatch: No suitable candidate found for 'add_int', with signature 'PIP-\u003eP'\ncurrent instr.: 'main' pc 24 (hash-2.pir:12)\n$ trunk/parrot hash-2.pir\nMultiple Dispatch: No suitable candidate found for 'add_int', with signature 'PIP-\u003eP'\ncurrent instr.: 'main' pc 24 (hash-2.pir:13)\n$ \n```\n\nThe underlying problem appears to be that starting with the 1.4.0 release, hash iterators began returning HashIteratorKey PMCs instead of String PMCs:\n\n```\n$ cat hash-3.pir\n.sub 'main'\n    .local pmc hash, hash_it\n    hash = new ['Hash']\n    hash['1'] = 'a' \n    hash['2'] = 'b'\n    hash['3'] = 'c'\n\n    hash_it = iter hash\n  loop:\n    unless hash_it goto done\n    $P0 = shift hash_it\n    $P1 = typeof $P0\n    say $P1\n    goto loop\n  done:\n.end\n\n$ 37535/parrot hash-3.pir\nString\nString\nString\n$ 39599/parrot hash-3.pir\nString\nString\nString\n$ 40185/parrot hash-3.pir\nHashIteratorKey\nHashIteratorKey\nHashIteratorKey\n$ trunk/parrot hash-3.pir\nHashIteratorKey\nHashIteratorKey\nHashIteratorKey\n$ \n```\n\nIt seems to me that a change of this sort should have been preceded by a deprecation notice -- as far as I can tell no such notice was given.  Regardless, returning a HashIteratorKey PMC would seem to be the least usable or useful of any of the options available.\n\nPm\n\nOriginally http://trac.parrot.org/parrot/ticket/1253","files":null}]}