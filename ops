{"version":1,"ops":[{"type":5,"author":{"id":"86141a663c2eb7543d1a51ec6253a1d54de912fd"},"timestamp":1421915091,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDIyMjg2Njc5MA=="},"added":["Bug"],"removed":[]},{"type":5,"author":{"id":"86141a663c2eb7543d1a51ec6253a1d54de912fd"},"timestamp":1421915100,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDIyMjg2Njg0Ng=="},"added":["Threads"],"removed":[]},{"type":5,"author":{"id":"86141a663c2eb7543d1a51ec6253a1d54de912fd"},"timestamp":1421915113,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDIyMjg2Njk0NA=="},"added":["Sev-fatal"],"removed":[]},{"type":3,"author":{"id":"86141a663c2eb7543d1a51ec6253a1d54de912fd"},"timestamp":1421915600,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDcwOTg3MDk3","github-url":"https://github.com/parrot/parrot/issues/1187#issuecomment-70987097"},"message":"With `-O3 -g` after the changed LOCK, we only got our usual possible races:\n\n```\n$ tsan ./parrot examples/threads/chameneos.pbc\n==21711== ThreadSanitizer, a data race detector\n==21711== Copyright (C) 2008-2010, and GNU GPL'd, by Google Inc.\n==21711== Using Valgrind-3.8.0.SVN and LibVEX; rerun with -h for copyright info\n==21711== Command: ./parrot examples/threads/chameneos.pbc\n==21711== \n==21711== ThreadSanitizerValgrind r4356: hybrid=no\n==21711== INFO: Allocating 256Mb (32 * 8M) for Segments.\n==21711== INFO: Will allocate up to 640Mb for 'previous' stack traces.\n==21711== INFO: T0 is program's main thread\n==21711== INFO: T2 has been created by T0. Use --announce-threads to see the creation stack.\n==21711== WARNING: Possible data race during read of size 8 at 0x4223410: {{{\n==21711==    T0 (L{}):\n==21711==     #0  gc_gms_allocate_pmc_header /usr/src/parrot/parrot-git/src/gc/gc_gms.c:1526\n==21711==     #1  Parrot_gc_new_pmc_header /usr/src/parrot/parrot-git/src/gc/api.c:314\n==21711==     #2  Parrot_pmc_new /usr/src/parrot/parrot-git/src/pmc.c:572\n==21711==     #3  Parrot_new_p_pc /usr/src/parrot/parrot-git/src/ops/core_ops.c:19660\n==21711==     #4  runops_fast_core /usr/src/parrot/parrot-git/src/runcore/cores.c:495\n==21711==     #5  runops_int /usr/src/parrot/parrot-git/src/runcore/main.c:220\n==21711==     #6  runops /usr/src/parrot/parrot-git/src/call/ops.c:123\n==21711==     #7  Parrot_pcc_invoke_from_sig_object /usr/src/parrot/parrot-git/src/call/pcc.c:307\n==21711==     #8  Parrot_ext_call /usr/src/parrot/parrot-git/src/extend.c:164\n==21711==     #9  Parrot_Task_invoke /usr/src/parrot/parrot-git/./src/pmc/task.pmc:175\n==21711==     #10 Parrot_pcc_invoke_from_sig_object /usr/src/parrot/parrot-git/src/call/pcc.c:299\n==21711==     #11 Parrot_ext_call /usr/src/parrot/parrot-git/src/extend.c:155\n==21711==   Concurrent write(s) happened at (OR AFTER) these points:\n==21711==    T2 (L{L12}):\n==21711==     #0  gc_gms_allocate_pmc_attributes /usr/src/parrot/parrot-git/src/gc/gc_gms.c:1358\n==21711==     #1  Parrot_pmc_new /usr/src/parrot/parrot-git/src/pmc.c:577\n==21711==     #2  Parrot_Sub_clone /usr/src/parrot/parrot-git/./src/pmc/sub.pmc:542\n==21711==     #3  Parrot_thread_create_local_sub /usr/src/parrot/parrot-git/src/thread.c:179\n==21711==     #4  Parrot_thread_create_local_task /usr/src/parrot/parrot-git/src/thread.c:234\n==21711==     #5  Parrot_ParrotInterpreter_nci_schedule_proxied /usr/src/parrot/parrot-git/./src/pmc/parrotinterpreter.pmc:712\n==21711==     #6  Parrot_NativePCCMethod_invoke /usr/src/parrot/parrot-git/./src/pmc/nativepccmethod.pmc:119\n==21711==     #7  runops_fast_core /usr/src/parrot/parrot-git/src/runcore/cores.c:495\n==21711==     #8  runops_int /usr/src/parrot/parrot-git/src/runcore/main.c:220\n==21711==     #9  runops /usr/src/parrot/parrot-git/src/call/ops.c:123\n==21711==   Location 0x4223410 is 432 bytes inside a block starting at 0x4223260 of size 456 allocated by T0 from heap:\n==21711==     #0  calloc /mnt/data/build/slave/full_linux_build/build/tsan/ts_valgrind_intercepts.c:444\n==21711==     #1  mem_sys_allocate_zeroed /usr/src/parrot/parrot-git/src/gc/alloc_memory.c:102\n==21711==     #2  Parrot_interp_allocate_interpreter /usr/src/parrot/parrot-git/src/interp/api.c:228\n==21711==     #3  Parrot_api_make_interpreter /usr/src/parrot/parrot-git/src/embed/api.c:131\n==21711==     #4  main /usr/src/parrot/parrot-git/frontend/parrot2/main.c:147\n==21711==   Locks involved in this report (reporting last lock sites): {L12}\n==21711==    L12 (0x4343170)\n==21711==     #0  pthread_mutex_lock /mnt/data/build/slave/full_linux_build/build/tsan/ts_valgrind_intercepts.c:935\n==21711==     #1  gc_gms_unblock_GC_mark_locked /usr/src/parrot/parrot-git/src/gc/gc_gms.c:1940\n==21711==     #2  Parrot_NativePCCMethod_invoke /usr/src/parrot/parrot-git/./src/pmc/nativepccmethod.pmc:119\n==21711==     #3  runops_fast_core /usr/src/parrot/parrot-git/src/runcore/cores.c:495\n==21711==     #4  runops_int /usr/src/parrot/parrot-git/src/runcore/main.c:220\n==21711==     #5  runops /usr/src/parrot/parrot-git/src/call/ops.c:123\n==21711==     #6  Parrot_pcc_invoke_from_sig_object /usr/src/parrot/parrot-git/src/call/pcc.c:307\n==21711==     #7  Parrot_ext_call /usr/src/parrot/parrot-git/src/extend.c:164\n==21711==     #8  Parrot_Task_invoke /usr/src/parrot/parrot-git/./src/pmc/task.pmc:175\n==21711==     #9  Parrot_pcc_invoke_from_sig_object /usr/src/parrot/parrot-git/src/call/pcc.c:299\n==21711==     #10 Parrot_ext_call /usr/src/parrot/parrot-git/src/extend.c:155\n==21711==     #11 Parrot_thread_outer_runloop /usr/src/parrot/parrot-git/src/thread.c:322\n==21711==    Race verifier data: 0x4ED8BFC,0x4ED769C\n==21711== }}}\ngoing to sleep\n==21711== INFO: T1 has been created by T0. Use --announce-threads to see the creation stack.\n==21711== WARNING: Possible data race during read of size 8 at 0x529B6D8: {{{\n==21711==    T0 (L{}):\n==21711==     #0  Parrot_alarm_check /usr/src/parrot/parrot-git/src/alarm.c:158\n==21711==     #1  Parrot_cx_check_scheduler /usr/src/parrot/parrot-git/src/scheduler.c:253\n==21711==     #2  Parrot_branch_ic /usr/src/parrot/parrot-git/src/ops/core_ops.c:13736\n==21711==     #3  runops_fast_core /usr/src/parrot/parrot-git/src/runcore/cores.c:495\n==21711==     #4  runops_int /usr/src/parrot/parrot-git/src/runcore/main.c:220\n==21711==     #5  runops /usr/src/parrot/parrot-git/src/call/ops.c:123\n==21711==     #6  Parrot_pcc_invoke_from_sig_object /usr/src/parrot/parrot-git/src/call/pcc.c:307\n==21711==     #7  Parrot_ext_call /usr/src/parrot/parrot-git/src/extend.c:164\n==21711==     #8  Parrot_Task_invoke /usr/src/parrot/parrot-git/./src/pmc/task.pmc:175\n==21711==     #9  Parrot_pcc_invoke_from_sig_object /usr/src/parrot/parrot-git/src/call/pcc.c:299\n==21711==     #10 Parrot_ext_call /usr/src/parrot/parrot-git/src/extend.c:155\n==21711==     #11 Parrot_cx_outer_runloop /usr/src/parrot/parrot-git/src/scheduler.c:149\n==21711==   Concurrent write(s) happened at (OR AFTER) these points:\n==21711==    T1 (L{L3}):\n==21711==     #0  Parrot_alarm_runloop /usr/src/parrot/parrot-git/src/alarm.c:129\n==21711==   Address 0x529B6D8 is 0 bytes inside data symbol \"alarm_serial\"\n==21711==   Locks involved in this report (reporting last lock sites): {L3}\n==21711==    L3 (0x529B6A0)\n==21711==     #0  pthread_mutex_lock /mnt/data/build/slave/full_linux_build/build/tsan/ts_valgrind_intercepts.c:935\n==21711==     #1  Parrot_alarm_runloop /usr/src/parrot/parrot-git/src/alarm.c:86\n==21711==    Race verifier data: 0x4ED2B50,0x4ED2AC3\n==21711== }}}\n==21711== INFO: T4 has been created by T0. Use --announce-threads to see the creation stack.\n==21711== WARNING: Possible data race during read of size 8 at 0x42FAB98: {{{\n==21711==    T4 (L{}):\n==21711==     #0  Parrot_Scheduler_unshift_pmc /usr/src/parrot/parrot-git/./src/pmc/scheduler.pmc:152\n==21711==     #1  Parrot_cx_schedule_immediate /usr/src/parrot/parrot-git/src/scheduler.c:525\n==21711==     #2  Parrot_ParrotInterpreter_nci_schedule_proxied /usr/src/parrot/parrot-git/./src/pmc/parrotinterpreter.pmc:712\n==21711==     #3  Parrot_NativePCCMethod_invoke /usr/src/parrot/parrot-git/./src/pmc/nativepccmethod.pmc:119\n==21711==     #4  runops_fast_core /usr/src/parrot/parrot-git/src/runcore/cores.c:495\n==21711==     #5  runops_int /usr/src/parrot/parrot-git/src/runcore/main.c:220\n==21711==     #6  runops /usr/src/parrot/parrot-git/src/call/ops.c:123\n==21711==     #7  Parrot_pcc_invoke_from_sig_object /usr/src/parrot/parrot-git/src/call/pcc.c:307\n==21711==     #8  Parrot_ext_call /usr/src/parrot/parrot-git/src/extend.c:164\n==21711==     #9  Parrot_Task_invoke /usr/src/parrot/parrot-git/./src/pmc/task.pmc:175\n==21711==     #10 Parrot_pcc_invoke_from_sig_object /usr/src/parrot/parrot-git/src/call/pcc.c:299\n==21711==     #11 Parrot_ext_call /usr/src/parrot/parrot-git/src/extend.c:155\n==21711==   Concurrent write(s) happened at (OR AFTER) these points:\n==21711==    T0 (L{}):\n==21711==     #0  Parrot_cx_next_task /usr/src/parrot/parrot-git/src/scheduler.c:717\n==21711==     #1  Parrot_cx_outer_runloop /usr/src/parrot/parrot-git/src/scheduler.c:149\n==21711==     #2  Parrot_cx_begin_execution /usr/src/parrot/parrot-git/src/scheduler.c:109\n==21711==     #3  Parrot_pf_execute_bytecode_program /usr/src/parrot/parrot-git/src/packfile/api.c:2905\n==21711==     #4  Parrot_api_run_bytecode /usr/src/parrot/parrot-git/src/embed/bytecode.c:161\n==21711==     #5  main /usr/src/parrot/parrot-git/frontend/parrot2/main.c:190\n==21711==   Location 0x42FAB98 is 1384 bytes inside a block starting at 0x42FA630 of size 4096 allocated by T0 from heap:\n==21711==     #0  calloc /mnt/data/build/slave/full_linux_build/build/tsan/ts_valgrind_intercepts.c:444\n==21711==     #1  mem_sys_allocate_zeroed /usr/src/parrot/parrot-git/src/gc/alloc_memory.c:102\n==21711==     #2  allocate_new_pool_arena /usr/src/parrot/parrot-git/src/gc/fixed_allocator.c:543\n==21711==     #3  Parrot_gc_pool_allocate /usr/src/parrot/parrot-git/src/gc/fixed_allocator.c:444\n==21711==     #4  gc_gms_allocate_pmc_header /usr/src/parrot/parrot-git/src/gc/gc_gms.c:1551\n==21711==     #5  Parrot_gc_new_pmc_header /usr/src/parrot/parrot-git/src/gc/api.c:314\n==21711==     #6  Parrot_pmc_new /usr/src/parrot/parrot-git/src/pmc.c:572\n==21711==     #7  Parrot_nci_load_extra_thunks /usr/src/parrot/parrot-git/src/nci/extra_thunks.c:4735\n==21711==     #8  init_world /usr/src/parrot/parrot-git/src/global_setup.c:226\n==21711==     #9  Parrot_interp_initialize_interpreter /usr/src/parrot/parrot-git/src/interp/api.c:291\n==21711==    Race verifier data: 0x4FAF62F,0x4F02C00\n==21711== }}}\n==21711== WARNING: Possible data race during read of size 8 at 0x432EF60: {{{\n==21711==    T2 (L{}):\n==21711==     #0  Parrot_Scheduler_shift_pmc /usr/src/parrot/parrot-git/./src/pmc/scheduler.pmc:172\n==21711==     #1  Parrot_cx_next_task /usr/src/parrot/parrot-git/src/scheduler.c:216\n==21711==     #2  Parrot_thread_outer_runloop /usr/src/parrot/parrot-git/src/thread.c:322\n==21711==   Concurrent write(s) happened at (OR AFTER) these points:\n==21711==    T0 (L{L76}):\n==21711==     #0  Parrot_cx_schedule_immediate /usr/src/parrot/parrot-git/src/scheduler.c:526\n==21711==     #1  Parrot_Task_invoke /usr/src/parrot/parrot-git/./src/pmc/task.pmc:215\n==21711==     #2  Parrot_pcc_invoke_from_sig_object /usr/src/parrot/parrot-git/src/call/pcc.c:299\n==21711==     #3  Parrot_ext_call /usr/src/parrot/parrot-git/src/extend.c:155\n==21711==     #4  Parrot_cx_outer_runloop /usr/src/parrot/parrot-git/src/scheduler.c:149\n==21711==     #5  Parrot_cx_begin_execution /usr/src/parrot/parrot-git/src/scheduler.c:109\n==21711==     #6  Parrot_pf_execute_bytecode_program /usr/src/parrot/parrot-git/src/packfile/api.c:2905\n==21711==     #7  Parrot_api_run_bytecode /usr/src/parrot/parrot-git/src/embed/bytecode.c:161\n==21711==     #8  main /usr/src/parrot/parrot-git/frontend/parrot2/main.c:190\n==21711==   Location 0x432EF60 is 64 bytes inside a block starting at 0x432EF20 of size 4096 allocated by T0 from heap:\n==21711==     #0  calloc /mnt/data/build/slave/full_linux_build/build/tsan/ts_valgrind_intercepts.c:444\n==21711==     #1  mem_sys_allocate_zeroed /usr/src/parrot/parrot-git/src/gc/alloc_memory.c:102\n==21711==     #2  allocate_new_pool_arena /usr/src/parrot/parrot-git/src/gc/fixed_allocator.c:543\n==21711==     #3  Parrot_gc_pool_allocate /usr/src/parrot/parrot-git/src/gc/fixed_allocator.c:444\n==21711==     #4  gc_gms_allocate_pmc_header /usr/src/parrot/parrot-git/src/gc/gc_gms.c:1551\n==21711==     #5  Parrot_gc_new_pmc_header /usr/src/parrot/parrot-git/src/gc/api.c:314\n==21711==     #6  Parrot_pmc_new_init /usr/src/parrot/parrot-git/src/pmc.c:572\n==21711==     #7  Parrot_thread_create_proxy /usr/src/parrot/parrot-git/src/thread.c:156\n==21711==     #8  Parrot_interp_clone /usr/src/parrot/parrot-git/src/interp/api.c:422\n==21711==     #9  Parrot_thread_create /usr/src/parrot/parrot-git/src/thread.c:76\n==21711==   Locks involved in this report (reporting last lock sites): {L76}\n==21711==    L76 (0x4343FB8)\n==21711==     #0  pthread_mutex_lock /mnt/data/build/slave/full_linux_build/build/tsan/ts_valgrind_intercepts.c:935\n==21711==     #1  Parrot_Task_invoke /usr/src/parrot/parrot-git/./src/pmc/task.pmc:204\n==21711==     #2  Parrot_pcc_invoke_from_sig_object /usr/src/parrot/parrot-git/src/call/pcc.c:299\n==21711==     #3  Parrot_ext_call /usr/src/parrot/parrot-git/src/extend.c:155\n==21711==     #4  Parrot_cx_outer_runloop /usr/src/parrot/parrot-git/src/scheduler.c:149\n==21711==     #5  Parrot_cx_begin_execution /usr/src/parrot/parrot-git/src/scheduler.c:109\n==21711==     #6  Parrot_pf_execute_bytecode_program /usr/src/parrot/parrot-git/src/packfile/api.c:2905\n==21711==     #7  Parrot_api_run_bytecode /usr/src/parrot/parrot-git/src/embed/bytecode.c:161\n==21711==     #8  main /usr/src/parrot/parrot-git/frontend/parrot2/main.c:190\n==21711==    Race verifier data: 0x4FAF6EE,0x4F03031\n==21711== }}}\nwoke up just in time for exit\n2\n==21711== \n==21711== ThreadSanitizer summary: reported 4 warning(s) (4 race(s))\n```","files":null},{"type":4,"author":{"id":"86141a663c2eb7543d1a51ec6253a1d54de912fd"},"timestamp":1422014406,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50MjIzNjQ3ODY5"},"status":2}]}