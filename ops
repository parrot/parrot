{"version":1,"ops":[{"type":1,"author":{"id":"6d59fc378929d99368e023bcfc49aacae1e68aad"},"timestamp":1295235071,"metadata":{"github-id":"MDU6SXNzdWUyODQ4Nzgy","github-url":"https://github.com/parrot/parrot/issues/574","origin":"github"},"title":"Oplib paths are truncated in PBC files","message":"The problem seems to be that IMCC uses the correct path to load the oplib object file when compiling, but drops all directory information when producing the packfile, so that loading the PBC file fails to find the library.\n1.  Unpack the attached test case tarball, and edit the PARROT-HOME macro in the makefile to point to a local Parrot working copy.\n2.  Run \"make\" to build and run the test.  Here's what the output looks like on my machine (GNU/Linux, openSUSE 11.3):\n   \n   rogers@rgr\u003e make\n   /usr/src/parrot/ops2c --dynamic dynops/kea_cl.ops --quiet\n   cc -I/usr/src/parrot/include -I/usr/src/parrot/include/pmc \\\n           -o dynops/kea_cl_ops.o -c dynops/kea_cl_ops.c\n   ld -o dynops/kea_cl_ops.so dynops/kea_cl_ops.o -shared\n   /usr/src/parrot/parrot -o test.pbc test.pir\n   /usr/src/parrot/parrot -o aux.pbc aux.pir\n   /usr/src/parrot/parrot test.pbc\n   Could not load oplib `kea_cl_ops'\n   current instr.: 'main' pc 0 (test.pir:4)\n   make: **\\* [test] Error 1\n   rogers@rgr\u003e \n3.  Apply parrot-lib-debugging.patch to the Parrot working copy, do \"make parrot\", and rerun the test:\n   \n   rogers@rgr\u003e make clean\n   rm -f _.pbc *.dump *.dis dynops/kea_cl_ops._\n   rogers@rgr\u003e make\n   /usr/src/parrot/ops2c --dynamic dynops/kea_cl.ops --quiet\n   Got path '/usr/src/parrot/runtime/parrot/dynext/os.so' for os\n   cc -I/usr/src/parrot/include -I/usr/src/parrot/include/pmc \\\n           -o dynops/kea_cl_ops.o -c dynops/kea_cl_ops.c\n   ld -o dynops/kea_cl_ops.so dynops/kea_cl_ops.o -shared\n   /usr/src/parrot/parrot -o test.pbc test.pir\n   Got path 'dynops/kea_cl_ops.so' for dynops/kea_cl_ops\n   /usr/src/parrot/parrot -o aux.pbc aux.pir\n   Got path 'dynops/kea_cl_ops.so' for dynops/kea_cl_ops\n   /usr/src/parrot/parrot test.pbc\n   Got path '' for kea_cl_ops\n   Could not load oplib `kea_cl_ops'\n   current instr.: 'main' pc 0 (test.pir:4)\n   make: **\\* [test] Error 1\n   rogers@rgr\u003e \n\nThis shows that IMCC is looking for \"dynops/kea_cl_ops\" (as you would expect), but the PBC file is looking for \"kea_cl_ops\" at load time and failing.  Indeed, if you do \"strings aux.pbc\", you will find the latter but not the former.  (As an aside, pbc_dump and pbc_disassemble do not work on aux.pbc.  Unless you copy dynops/kea_cl_ops.so to runtime/parrot/dynext/ in the Parrot working copy, where it will be found.)\n1.  Change the aux.pir source to use the absolute pathname.  This does not help:\n   \n   rogers@rgr\u003e make\n   /usr/src/parrot/parrot -o aux.pbc aux.pir\n   Got path '/home/rogers/projects/kea2/bug/dynops/kea_cl_ops.so' for /home/rogers/projects/kea2/bug/dynops/kea_cl_ops\n   /usr/src/parrot/parrot test.pbc\n   Got path '' for kea_cl_ops\n   Could not load oplib `kea_cl_ops'\n   current instr.: 'main' pc 0 (test.pir:4)\n   make: **\\* [test] Error 1\n   rogers@rgr\u003e \n\nAs before, just \"kea_cl_ops\" is stored in the PBC file.\n\nFWIW, Parrot has never had this problem with dynamic PMC classes; the exact pathname used in the .loadlib directive makes it into the PBC file.\n\nOriginally http://trac.parrot.org/parrot/ticket/1971 by rgrjr","files":null}]}