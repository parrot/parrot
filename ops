{"version":1,"ops":[{"type":3,"author":{"id":"aef4977f5ea786238d7c9581a2f192f4adc3f39d"},"timestamp":1336483273,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1NzQzNTE=","github-url":"https://github.com/parrot/parrot/issues/767#issuecomment-5574351"},"message":"The String.reverse_index method eventually leads back to the encoding_rindex() function in https://github.com/parrot/parrot/blob/master/src/string/encoding/shared.c. I wont have time to look at this issue until tonight.\n\nIf some other developer wants to set up a  debugger with breakpoints at Parrot_String_nci_reverse_index and encoding_rindex and figure out where the operation is going wrong with the unicode strings, that would be a big help.","files":null},{"type":3,"author":{"id":"0c9c62332064205b2d799407019fa3e7e2f43862"},"timestamp":1336483730,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1NzQ1MzA=","github-url":"https://github.com/parrot/parrot/issues/767#issuecomment-5574530"},"message":"See also Rakudo bug [RT #112818](https://rt.perl.org/rt3/Ticket/Display.html?id=112818).\n\nPm","files":null},{"type":3,"author":{"id":"aef4977f5ea786238d7c9581a2f192f4adc3f39d"},"timestamp":1336483880,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1NzQ2MDE=","github-url":"https://github.com/parrot/parrot/issues/767#issuecomment-5574601"},"message":"Actually, on further inspection I suspect the unicode case is actually working correctly, while the ascii case is the one that has the bug. The String PMC source code has this to say about reverse_index:\n\nFind last occurrence of `substring`, but not after the `start` position.\n\nIn the example above, calling `$I0 = $P0.'reverse_index'('e', 4)` (notice changing the poorly-named \"start\" parameter to 4) gives us the correct expected answer. If that's the case, we have a few things to look at:\n1. The ASCII case needs to be fixed to return -1 in this case\n2. The reverse_index method probably needs a better interface where the parameter is renamed something less confusing, and is optional in the case where we just want to search the whole string. \n\nDoes this sound reasonable to do?","files":null},{"type":3,"author":{"id":"646f0669ead6eaf64196bebf3884a5eff162357a"},"timestamp":1336485187,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1NzUwODM=","github-url":"https://github.com/parrot/parrot/issues/767#issuecomment-5575083"},"message":"The unicode version of `reverse_index` is `encoding_rindex`, but the ASCII version is `fixed8_rindex` which is a thin wrapper around `Parrot_util_byte_rindex`.\n\n`encoding_rindex` says \"oh, you wanted to start searching backwards at position 0\" and returns -1.\n\n`Parrot_util_byte_rindex` says \"oh, you gave me false for start, I'll start at the end of the string\".  (src/util.c:642)\n\nBased on the documentation for reverse_index, I'd also argue that the ASCII case is wrong.  Making the parameter optional and defaulting to \"search the whole string\" does seem the saner direction to go.","files":null},{"type":4,"author":{"id":"aef4977f5ea786238d7c9581a2f192f4adc3f39d"},"timestamp":1336519766,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50MTUwNDMxNDc="},"status":2},{"type":3,"author":{"id":"aef4977f5ea786238d7c9581a2f192f4adc3f39d"},"timestamp":1336519889,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDU1ODkzMjY=","github-url":"https://github.com/parrot/parrot/issues/767#issuecomment-5589326"},"message":"I've fixed the reverse_index method so the second parameter is optional (defaults to length(str)) and to return -1 on the ascii case as well as the unicode case. Also, on request from @moritz, I've added two new experimental rindex (i_s_s and i_s_s_i) opcodes, which perform exactly the same operation but do not require you to create a String PMC first, which should help with GC pressure.","files":null}]}