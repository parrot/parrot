/* NCI.pmc
 *  Copyright: 2001-2003 The Perl Foundation.  All Rights Reserved.
 *  CVS Info
 *     $Id$
 *  Overview:
 *     The vtable functions for the native C call functions
 *  Data Structure and Algorithms:
 *  History:
 *     Initial revision by sean 2002/08/04
 *  Notes:
 *     Invoking a NCI function changes some registers according to pdd03.
 *     The caller has to preserve registers if needed.
 *  References:
 *     docs/pdds/pdd03_calling_conventions.pod
 */

#include "parrot/parrot.h"
#include "parrot/method_util.h"

pmclass NCI need_ext {

    void init() {
	PMC_struct_val(SELF) = NULL;
    }

    void set_string_keyed (PMC* func, STRING* value) {
	/* key = func_ptr, value = signature */
	PMC_struct_val(SELF) = (DPOINTER *)func;
	PMC_data(SELF) = build_call_func(INTERP, SELF, value);
    }

    void destroy() {
	if (PMC_data(SELF))
	    mem_free_executable(PMC_data(SELF));
    }

    PMC* clone () {
	PMC* ret = pmc_new_noinit(INTERP, SELF->vtable->base_type);
        PMC_struct_val(ret) = PMC_struct_val(SELF);
	/* FIXME if data is malloced (JIT/i386!) then we need
	 * the length of data here, to memcpy it
	 * ManagedStruct or Buffer?
	 */
	PMC_data(ret) = PMC_data(SELF);
	return ret;
    }

    INTVAL defined () {
        return PMC_data(SELF) != NULL;
    }

    void* invoke (void * next) {
        Parrot_csub_t func = (Parrot_csub_t)D2FPTR(PMC_data(SELF));
        func(INTERP, SELF);
        return next;
    }
    INTVAL get_integer () {
	return((INTVAL)PMC_data(SELF));
    }

}
