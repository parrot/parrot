{"version":1,"ops":[{"type":1,"author":{"id":"86141a663c2eb7543d1a51ec6253a1d54de912fd"},"timestamp":1421915091,"metadata":{"github-id":"MDU6SXNzdWU1NTEyNjQxMg==","github-url":"https://github.com/parrot/parrot/issues/1187","origin":"github"},"title":"threads deadlock in gc_gms_mark_and_sweep()","message":"With the new `--optimized=-O3`\n`./parrot examples/threads/chameneos.pbc` hangs\n\n$ gdb -p 32197  --args ./parrot examples/threads/chameneos.pbc\n\n```\n__lll_lock_wait () at ../nptl/sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:135\n135 in ../nptl/sysdeps/unix/sysv/linux/x86_64/lowlevellock.S\n(gdb) bt\n#0  __lll_lock_wait () at ../nptl/sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:135\n#1  0x00007f3b045e84b9 in _L_lock_909 () from /lib/x86_64-linux-gnu/libpthread.so.0\n#2  0x00007f3b045e82e0 in __GI___pthread_mutex_lock (mutex=0xf48170) at ../nptl/pthread_mutex_lock.c:79\n#3  0x00007f3b06fc83a4 in gc_gms_mark_and_sweep ()\n   from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#4  0x00007f3b06fca66b in pool_allocate () from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#5  0x00007f3b06fc7aac in gc_gms_allocate_fixed_size_storage ()\n   from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#6  0x00007f3b07044fba in ensure_positionals_storage_ap ()\n   from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#7  0x00007f3b07045b90 in Parrot_CallContext_push_pmc ()\n   from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#8  0x00007f3b06fcf0b6 in set_call_from_varargs ()\n   from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#9  0x00007f3b06fd06f0 in Parrot_pcc_build_call_from_varargs ()\n   from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#10 0x00007f3b06fc28ce in Parrot_ext_call ()\n   from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#11 0x00007f3b0709a9b6 in Parrot_Task_invoke ()\n   from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#12 0x00007f3b06fce48c in Parrot_pcc_invoke_from_sig_object ()\n   from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#13 0x00007f3b06fc295f in Parrot_ext_call ()\n   from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#14 0x00007f3b06fef3ed in Parrot_cx_outer_runloop ()\n   from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#15 0x00007f3b06fef4e7 in Parrot_cx_begin_execution ()\n   from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#16 0x00007f3b06ff7ddb in Parrot_pf_execute_bytecode_program ()\n   from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#17 0x00007f3b06fbe8a8 in Parrot_api_run_bytecode ()\n   from /home/rurban/Perl/p6/parrot-git/blib/lib/libparrot.so.7.0.0\n#18 0x0000000000401f75 in main ()\n```\n\nwe need to move the lock downwards to the guard","files":null}]}